<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∞ (iPad Compatible)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #FFF8F0; /* [cite: 114] */
            --surface-color: #FFFFFF; /* [cite: 115] */
            --text-color: #3D2C2E; /* [cite: 116] */
            --primary-color: #E8734A; /* [cite: 117] */
            --secondary-color: #F4A261; /* [cite: 118] */
            --border-color: #E8D5C4; /* [cite: 119] */
        }

        body { 
            font-family: 'Sarabun', 'Prompt', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 20px 16px;
            -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 900px; margin: 0 auto; }

        .card {
            background: var(--surface-color);
            border-radius: 16px;
            box-shadow: 0 2px 16px rgba(61,44,46,0.07);
            padding: 24px; margin-bottom: 20px;
        }

        .section-title { 
            font-size: 18px; font-weight: 700; color: var(--text-color);
            margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
        }

        .input-field {
            width: 100%; padding: 12px 14px; border: 2px solid var(--border-color);
            border-radius: 10px; font-family: inherit; background: #FFFCF9; outline: none; box-sizing: border-box;
            font-size: 16px; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô iOS Auto-zoom */
        }

        .btn-primary {
            background: var(--primary-color); color: white; border: none;
            border-radius: 12px; padding: 12px 24px; font-weight: 600; cursor: pointer; 
            transition: all 0.2s; touch-action: manipulation;
        }

        .table-container { overflow-x: auto; border-radius: 12px; border: 2px solid #F0DFD0; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 14px; }
        th { background: #F8F1EA; padding: 14px; text-align: left; font-weight: 600; }
        td { padding: 12px 14px; border-bottom: 1px solid #F0E6DC; background: white; }
        
        .tab-btn {
            padding: 10px 16px; border: 2px solid var(--border-color);
            background: white; border-radius: 10px; cursor: pointer; font-weight: 600; color: #9B8578;
            white-space: nowrap;
        }
        .tab-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .txt-‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö { color: #1B8C5A; font-weight: bold; }
        .txt-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ { color: #E74C3C; font-weight: bold; }
        .summary-card { padding: 16px; border-radius: 14px; text-align: center; font-weight: bold; }

        #importPreviewArea {
            display: none; margin-bottom: 20px; border: 2px solid #3498db; 
            padding: 20px; border-radius: 16px; background: #ebf5fb;
        }

        .bulk-bar {
            display: none; background: #FFF0E0; border: 2px solid var(--primary-color);
            border-radius: 12px; padding: 12px 14px; margin-bottom: 14px; 
            justify-content: space-between; align-items: center;
        }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align:center; margin-bottom:30px;">
        <h1 style="font-size:28px; font-weight:700;">üìí ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
        <p style="color:#9B8578;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏ö‡∏≤‡∏ó ‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</p>
    </header>

    <div class="card" style="border: 2px solid var(--primary-color);">
        <div class="section-title">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
            <div class="summary-card" style="background: #E8F8F0; color: #1B8C5A;">
                <div style="font-size: 13px;">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</div>
                <div id="totalIncome">0.00 ‡∏ø</div>
            </div>
            <div class="summary-card" style="background: #FDECEC; color: #E74C3C;">
                <div style="font-size: 13px;">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
                <div id="totalExpense">0.00 ‡∏ø</div>
            </div>
            <div class="summary-card" style="background: #EBF0FF; color: #3B5BDB;">
                <div style="font-size: 13px;">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                <div id="netBalance">0.00 ‡∏ø</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="section-title">üè¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <input type="text" id="newAcc" class="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£" style="flex:2">
            <button onclick="addAccount()" class="btn-primary" style="flex:1">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
        <div id="accBadges" style="margin-top:15px; display:flex; gap:8px; flex-wrap:wrap;"></div>
    </div>

    <div id="accCards" style="display: flex; gap: 12px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 10px;"></div>

    <div class="card">
        <div class="section-title">üìù ‡∏•‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div><label style="font-size:13px; font-weight:600;">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="date" class="input-field"></div>
            <div><label style="font-size:13px; font-weight:600;">üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><select id="accSelect" class="input-field"></select></div>
            <div><label style="font-size:13px; font-weight:600;">üìä ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select id="type" class="input-field">
                    <option value="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
                    <option value="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" selected>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
                </select>
            </div>
            <div><label style="font-size:13px; font-weight:600;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="desc" class="input-field" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üç±"></div>
            <div><label style="font-size:13px; font-weight:600;">üíµ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input type="number" id="amt" class="input-field" placeholder="0.00"></div>
            <div><label style="font-size:13px; font-weight:600;">üñºÔ∏è ‡∏™‡∏•‡∏¥‡∏õ</label><input type="file" id="slipInput" class="input-field" accept="image/*" style="padding:7px;"></div>
        </div>
        <button class="btn-primary" onclick="saveData()" style="width:100%; margin-top:20px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ üí∞</button>
    </div>

    <div class="card">
        <div style="background: #FFF5EC; border: 2px dashed var(--secondary-color); padding: 16px; border-radius: 14px; margin-bottom: 20px;">
            <label style="font-weight:bold; color:var(--primary-color);">üìÇ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel:</label>
            <input type="file" accept=".xlsx" onchange="importFromExcel(this)" style="margin-top:10px; width:100%;">
        </div>

        <div id="importPreviewArea">
            <h3 style="margin-top:0; color:#2980b9;">üìã ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
            <div style="max-height: 200px; overflow-y: auto; background: white; border-radius: 8px; margin-bottom: 15px;">
                <table style="min-width: 100%;">
                    <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="confirmImportBtn" class="btn-primary" style="background:#27ae60; flex:1;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚úÖ</button>
                <button onclick="cancelImport()" class="btn-primary" style="background:#95a5a6; flex:1;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‚ùå</button>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <input type="month" id="filterMonth" class="input-field" onchange="updateUI()" style="width: auto;">
            <button onclick="exportExcelFull()" style="background:#2ECC71;" class="btn-primary">üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
        </div>

        <div id="bulkDeleteBar" class="bulk-bar">
            <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: <span id="selectedCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            <button onclick="bulkDelete()" style="background:#E74C3C; color:white; border:none; border-radius:10px; padding:8px 16px; font-weight:bold;">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>

        <div id="bankTabs" style="margin-bottom:15px; display:flex; gap:5px; overflow-x:auto; padding-bottom:5px;"></div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:40px;"><input type="checkbox" onchange="toggleAll(this)"></th>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentTab = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    let editingId = null;
    let accounts = JSON.parse(localStorage.getItem('FIN_V6_ACCS')) || ['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ', '‡∏Å‡∏™‡∏¥‡∏Å‡∏£ üè¶'];
    let logs = JSON.parse(localStorage.getItem('FIN_V6_LOGS')) || [];
    let selectedIds = new Set();
    let pendingLogs = [];

    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);

    function addAccount() {
        let name = document.getElementById('newAcc').value.trim();
        if(name && !accounts.includes(name)) { accounts.push(name); saveAndUI(); document.getElementById('newAcc').value = ''; }
    }

    function removeAccount(name) {
        if(confirm(`‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${name}?`)) { accounts = accounts.filter(a => a !== name); saveAndUI(); }
    }

    function saveData() {
        let amt = parseFloat(document.getElementById('amt').value) || 0;
        if(amt <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
        let file = document.getElementById('slipInput').files[0];
        if (file) {
            let reader = new FileReader();
            reader.onloadend = () => commitEntry(reader.result);
            reader.readAsDataURL(file);
        } else { commitEntry(""); }
    }

    function commitEntry(img) {
        logs.push({ 
            id: Date.now(), 
            date: document.getElementById('date').value, 
            acc: document.getElementById('accSelect').value, 
            type: document.getElementById('type').value, 
            desc: document.getElementById('desc').value || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", 
            amt: parseFloat(document.getElementById('amt').value), 
            slip: img 
        });
        document.getElementById('amt').value = '';
        document.getElementById('desc').value = '';
        saveAndUI();
    }

    function importFromExcel(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            pendingLogs = [];
            workbook.SheetNames.forEach(sheetName => {
                const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {range: 5});
                sheetData.forEach(row => { 
                    if(row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"]) { 
                        pendingLogs.push({ id: Date.now() + Math.random(), date: row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"], acc: sheetName, type: row["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"], desc: row["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"], amt: parseFloat(row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"]) || 0, slip: "" }); 
                    } 
                });
            });
            if(pendingLogs.length > 0) {
                document.getElementById('importPreviewArea').style.display = 'block';
                document.getElementById('previewBody').innerHTML = pendingLogs.slice(0, 50).map(l => `<tr><td>${l.date}</td><td>${l.acc}</td><td>${l.desc}</td><td>${l.amt.toLocaleString()}</td></tr>`).join('');
                document.getElementById('confirmImportBtn').onclick = executeImport;
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function executeImport() {
        logs = [...logs, ...pendingLogs];
        saveAndUI();
        cancelImport();
        alert("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    }

    function cancelImport() { 
        document.getElementById('importPreviewArea').style.display = 'none'; 
        pendingLogs = []; 
        document.querySelector('input[type="file"]').value = "";
    }

    function startEdit(id) { editingId = id; updateUI(); }
    function cancelEdit() { editingId = null; updateUI(); }
    function saveEdit(id) {
        const item = logs.find(l => l.id === id);
        if (item) {
            item.date = document.getElementById(`ed-date-${id}`).value;
            item.acc = document.getElementById(`ed-acc-${id}`).value;
            item.type = document.getElementById(`ed-type-${id}`).value;
            item.desc = document.getElementById(`ed-desc-${id}`).value;
            item.amt = parseFloat(document.getElementById(`ed-amt-${id}`).value) || 0;
            editingId = null; saveAndUI();
        }
    }

    function updateUI() {
        document.getElementById('accSelect').innerHTML = accounts.map(a => `<option value="${a}">${a}</option>`).join('');
        document.getElementById('accBadges').innerHTML = accounts.map(a => `<span style="background:#F0E6DC; padding:6px 12px; border-radius:20px; font-size:13px; font-weight:600;">${a} <b onclick="removeAccount('${a}')" style="color:red; cursor:pointer; margin-left:5px;">√ó</b></span>`).join('');
        
        let tabHtml = `<button class="tab-btn ${currentTab==='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'?'active':''}" onclick="setTab('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î üìë</button>`;
        accounts.forEach(a => { tabHtml += `<button class="tab-btn ${currentTab===a?'active':''}" onclick="setTab('${a}')">${a}</button>`; });
        document.getElementById('bankTabs').innerHTML = tabHtml;

        logs.sort((a,b) => new Date(a.date) - new Date(b.date));
        let bals = {}; accounts.forEach(a => bals[a] = 0);
        let processed = logs.map(l => {
            l.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? bals[l.acc] += l.amt : bals[l.acc] -= l.amt;
            return { ...l, runningBal: bals[l.acc] };
        });

        const fMonth = document.getElementById('filterMonth').value;
        let filtered = processed.filter(l => l.date.startsWith(fMonth));
        if(currentTab !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') filtered = filtered.filter(l => l.acc === currentTab);

        let sumIn = 0, sumOut = 0;
        filtered.forEach(l => { if(l.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö') sumIn += l.amt; else sumOut += l.amt; });
        document.getElementById('totalIncome').textContent = sumIn.toLocaleString() + " ‡∏ø";
        document.getElementById('totalExpense').textContent = sumOut.toLocaleString() + " ‡∏ø";
        document.getElementById('netBalance').textContent = (sumIn - sumOut).toLocaleString() + " ‡∏ø";

        document.getElementById('accCards').innerHTML = accounts.map(a => `
            <div style="min-width:160px; background:linear-gradient(135deg, var(--secondary-color), var(--primary-color)); color:white; padding:18px; border-radius:14px; text-align:center;">
                <div style="font-size:13px; opacity:0.9;">${a}</div>
                <div style="font-size:20px; font-weight:700; margin-top:5px;">${(bals[a] || 0).toLocaleString()} ‡∏ø</div>
            </div>`).join('');

        const tbody = document.getElementById('dataTable');
        tbody.innerHTML = '';
        [...filtered].reverse().forEach(l => {
            if (editingId === l.id) {
                let accOpts = accounts.map(a => `<option value="${a}" ${a===l.acc?'selected':''}>${a}</option>`).join('');
                tbody.innerHTML += `<tr>
                    <td></td>
                    <td><input type="date" id="ed-date-${l.id}" value="${l.date}" class="input-field"></td>
                    <td><select id="ed-acc-${l.id}" class="input-field">${accOpts}</select></td>
                    <td><select id="ed-type-${l.id}" class="input-field"><option value="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" ${l.type==='‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'?'selected':''}>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option><option value="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" ${l.type==='‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'?'selected':''}>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option></select></td>
                    <td><input type="text" id="ed-desc-${l.id}" value="${l.desc}" class="input-field"></td>
                    <td><input type="number" id="ed-amt-${l.id}" value="${l.amt}" class="input-field"></td>
                    <td>-</td>
                    <td><button onclick="saveEdit(${l.id})">‚úîÔ∏è</button></td>
                </tr>`;
            } else {
                let isSel = selectedIds.has(l.id);
                tbody.innerHTML += `<tr style="${isSel?'background:#FFF0E0':''}">
                    <td><input type="checkbox" onchange="toggleItem(${l.id})" ${isSel?'checked':''}></td>
                    <td>${l.date}</td><td><small>${l.acc}</small></td>
                    <td class="txt-${l.type}">${l.type}</td>
                    <td>${l.desc}</td>
                    <td class="txt-${l.type}">${l.amt.toLocaleString()}</td>
                    <td style="font-weight:bold">${l.runningBal.toLocaleString()}</td>
                    <td>
                        <button onclick="startEdit(${l.id})" style="border:none; background:none;">‚úèÔ∏è</button>
                        <button onclick="deleteEntry(${l.id})" style="border:none; background:none;">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }
        });
        updateBulkBar();
    }

    function toggleItem(id) { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); updateUI(); }
    function toggleAll(el) { 
        const fMonth = document.getElementById('filterMonth').value;
        let visible = logs.filter(l => l.date.startsWith(fMonth));
        if(currentTab !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') visible = visible.filter(l => l.acc === currentTab);
        if(el.checked) visible.forEach(l => selectedIds.add(l.id)); else selectedIds.clear();
        updateUI();
    }
    function updateBulkBar() {
        document.getElementById('selectedCount').textContent = selectedIds.size;
        document.getElementById('bulkDeleteBar').style.display = selectedIds.size > 0 ? 'flex' : 'none';
    }
    function bulkDelete() { if(confirm(`‡∏•‡∏ö ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) { logs = logs.filter(l => !selectedIds.has(l.id)); selectedIds.clear(); saveAndUI(); } }
    function deleteEntry(id) { if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) { logs = logs.filter(l => l.id !== id); saveAndUI(); } }
    function setTab(name) { currentTab = name; updateUI(); }
    function saveAndUI() { localStorage.setItem('FIN_V6_ACCS', JSON.stringify(accounts)); localStorage.setItem('FIN_V6_LOGS', JSON.stringify(logs)); updateUI(); }

    function exportExcelFull() {
        const selM = document.getElementById('filterMonth').value;
        const wb = XLSX.utils.book_new();
        accounts.forEach(acc => {
            const accLogs = logs.filter(l => l.acc === acc && l.date.startsWith(selM));
            if(accLogs.length === 0) return;
            const rows = [ ["‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: " + acc + " (" + selM + ")"], ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"] ];
            accLogs.forEach(l => rows.push([l.date, l.type, l.desc, l.amt]));
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, acc.substring(0,30));
        });
        XLSX.writeFile(wb, `Finance_Master_${selM}.xlsx`);
    }

    updateUI();
</script>
</body>

</html>
