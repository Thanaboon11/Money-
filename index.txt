<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∞ (‡∏£‡∏∏‡πà‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #FFF8F0;
            --surface-color: #FFFFFF;
            --text-color: #3D2C2E;
            --primary-color: #E8734A;
            --secondary-color: #F4A261;
            --border-color: #E8D5C4;
        }
        body { font-family: 'Sarabun', 'Prompt', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px 16px; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: var(--surface-color); border-radius: 16px; box-shadow: 0 2px 16px rgba(61,44,46,0.07); padding: 24px; margin-bottom: 20px; }
        .section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .input-field { width: 100%; padding: 12px 14px; border: 2px solid var(--border-color); border-radius: 10px; font-family: inherit; font-size: 16px; box-sizing: border-box; }
        .btn-primary { background: var(--primary-color); color: white; border: none; border-radius: 12px; padding: 12px 24px; font-weight: 600; cursor: pointer; width: 100%; }
        .table-container { overflow-x: auto; border-radius: 12px; border: 2px solid #F0DFD0; }
        table { width: 100%; border-collapse: collapse; min-width: 850px; }
        th { background: #F8F1EA; padding: 14px; text-align: left; }
        td { padding: 12px 14px; border-bottom: 1px solid #F0E6DC; background: white; }
        .txt-‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö { color: #1B8C5A; font-weight: bold; }
        .txt-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ { color: #E74C3C; font-weight: bold; }
        .tab-btn { padding: 8px 16px; border: 2px solid var(--border-color); background: white; border-radius: 10px; cursor: pointer; margin-right: 5px; }
        .tab-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .bulk-bar { display: none; background: #FFF0E0; border: 2px solid var(--primary-color); border-radius: 12px; padding: 12px 14px; margin-bottom: 14px; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align:center; margin-bottom:30px;">
        <h1 style="font-size:28px; font-weight:700;">üìí ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
    </header>

    <div class="card">
        <div class="section-title">üè¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="text" id="newAcc" class="input-field" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ ‡∏ö‡∏µ" style="flex:2">
            <button onclick="addAccount()" class="btn-primary" style="flex:1">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
        <div id="accBadges" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
    </div>

    <div id="accCards" style="display: flex; gap: 12px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 10px;"></div>

    <div class="card">
        <div class="section-title">üìù ‡∏•‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="date" class="input-field"></div>
            <div><label>üè¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><select id="accSelect" class="input-field"></select></div>
            <div><label>üìä ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="type" class="input-field"><option value="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option><option value="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" selected>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option></select></div>
            <div><label>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="desc" class="input-field" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"></div>
            <div><label>üíµ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input type="number" id="amt" class="input-field" placeholder="0.00"></div>
            <div><label>üñºÔ∏è ‡∏™‡∏•‡∏¥‡∏õ</label><input type="file" id="slipInput" class="input-field" accept="image/*" style="padding:7px;"></div>
        </div>
        <button class="btn-primary" onclick="saveData()" style="margin-top:20px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î üí∞</button>
    </div>

    <div class="card">
        <div style="background: #FFF5EC; border: 2px dashed var(--secondary-color); padding: 16px; border-radius: 14px; margin-bottom: 20px;">
            <label style="font-weight:bold;">üìÇ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå Excel (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPad):</label>
            <input type="file" accept=".xlsx" onchange="importExcel(this)" style="margin-top:10px; width:100%;">
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; gap: 10px;">
            <input type="month" id="filterMonth" class="input-field" onchange="updateUI()" style="width: auto;">
            <button onclick="exportExcelFull()" style="background:#2ECC71; width:auto;" class="btn-primary">üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
        </div>

        <div id="bulkDeleteBar" class="bulk-bar">
            <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: <span id="selectedCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            <button onclick="bulkDelete()" style="background:#E74C3C; color:white; border:none; border-radius:10px; padding:8px 16px;">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>

        <div id="bankTabs" style="display:flex; gap:5px; margin-bottom:15px; overflow-x:auto;"></div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" onchange="toggleAll(this)"></th>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ ‡∏ö‡∏µ" ‡πÅ‡∏•‡∏∞ "‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô"
    let accounts = JSON.parse(localStorage.getItem('FIN_V6_ACCS')) || ['‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ ‡∏ö‡∏µ', '‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô'];
    let logs = JSON.parse(localStorage.getItem('FIN_V6_LOGS')) || [];
    let currentTab = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    let editingId = null;
    let selectedIds = new Set();

    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);

    function addAccount() {
        let name = document.getElementById('newAcc').value.trim();
        if(name && !accounts.includes(name)) { accounts.push(name); saveAndUI(); document.getElementById('newAcc').value = ''; }
    }

    function removeAccount(name) {
        if(confirm(`‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${name}?`)) { accounts = accounts.filter(a => a !== name); saveAndUI(); }
    }

    function saveData() {
        let amt = parseFloat(document.getElementById('amt').value) || 0;
        if(amt <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
        let file = document.getElementById('slipInput').files[0];
        if (file) {
            let reader = new FileReader();
            reader.onloadend = () => commitEntry(reader.result);
            reader.readAsDataURL(file);
        } else { commitEntry(""); }
    }

    function commitEntry(img) {
        logs.push({ id: Date.now(), date: document.getElementById('date').value, acc: document.getElementById('accSelect').value, type: document.getElementById('type').value, desc: document.getElementById('desc').value || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", amt: parseFloat(document.getElementById('amt').value), slip: img });
        document.getElementById('amt').value = '';
        document.getElementById('desc').value = '';
        saveAndUI();
    }

    function importExcel(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            let newItems = [];
            workbook.SheetNames.forEach(name => {
                const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[name], {range: 5});
                sheetData.forEach(row => { if(row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"]) newItems.push({ id: Date.now()+Math.random(), date: row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"], acc: name, type: row["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"], desc: row["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"], amt: parseFloat(row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"])||0 }); });
            });
            if(newItems.length > 0 && confirm(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${newItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) { logs = [...logs, ...newItems]; saveAndUI(); }
            input.value = "";
        };
        reader.readAsArrayBuffer(file);
    }

    function updateUI() {
        document.getElementById('accSelect').innerHTML = accounts.map(a => `<option value="${a}">${a}</option>`).join('');
        document.getElementById('accBadges').innerHTML = accounts.map(a => `<span style="background:#F0E6DC; padding:6px 12px; border-radius:20px; font-size:13px;">${a} <b onclick="removeAccount('${a}')" style="color:red; cursor:pointer; margin-left:5px;">√ó</b></span>`).join('');
        
        let tabHtml = `<button class="tab-btn ${currentTab==='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'?'active':''}" onclick="setTab('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`;
        accounts.forEach(a => tabHtml += `<button class="tab-btn ${currentTab===a?'active':''}" onclick="setTab('${a}')">${a}</button>`);
        document.getElementById('bankTabs').innerHTML = tabHtml;

        logs.sort((a,b) => new Date(a.date) - new Date(b.date));
        let bals = {}; accounts.forEach(a => bals[a] = 0);
        let processed = logs.map(l => {
            l.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? bals[l.acc] += l.amt : bals[l.acc] -= l.amt;
            return { ...l, runningBal: bals[l.acc] };
        });

        const fMonth = document.getElementById('filterMonth').value;
        let filtered = processed.filter(l => l.date.startsWith(fMonth));
        if(currentTab !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') filtered = filtered.filter(l => l.acc === currentTab);

        document.getElementById('accCards').innerHTML = accounts.map(a => `
            <div style="min-width:140px; background:linear-gradient(135deg, #F4A261, #E8734A); color:white; padding:15px; border-radius:14px; text-align:center;">
                <div style="font-size:12px;">${a}</div>
                <div style="font-size:18px; font-weight:700;">${(bals[a] || 0).toLocaleString()} ‡∏ø</div>
            </div>`).join('');

        const tbody = document.getElementById('dataTable');
        tbody.innerHTML = [...filtered].reverse().map(l => `
            <tr style="${selectedIds.has(l.id)?'background:#FFF0E0':''}">
                <td><input type="checkbox" onchange="toggleItem(${l.id})" ${selectedIds.has(l.id)?'checked':''}></td>
                <td>${l.date}</td><td><small>${l.acc}</small></td>
                <td class="txt-${l.type}">${l.type}</td><td>${l.desc}</td>
                <td class="txt-${l.type}">${l.amt.toLocaleString()}</td>
                <td style="font-weight:bold">${l.runningBal.toLocaleString()}</td>
                <td><button onclick="deleteEntry(${l.id})" style="border:none; background:none; cursor:pointer;">üóëÔ∏è</button></td>
            </tr>`).join('');
        
        document.getElementById('bulkDeleteBar').style.display = selectedIds.size > 0 ? 'flex' : 'none';
        document.getElementById('selectedCount').textContent = selectedIds.size;
    }

    function toggleItem(id) { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); updateUI(); }
    function toggleAll(el) { if(el.checked) logs.forEach(l => selectedIds.add(l.id)); else selectedIds.clear(); updateUI(); }
    function bulkDelete() { if(confirm(`‡∏•‡∏ö ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) { logs = logs.filter(l => !selectedIds.has(l.id)); selectedIds.clear(); saveAndUI(); } }
    function deleteEntry(id) { if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) { logs = logs.filter(l => l.id !== id); saveAndUI(); } }
    function setTab(name) { currentTab = name; updateUI(); }
    function saveAndUI() { localStorage.setItem('FIN_V6_ACCS', JSON.stringify(accounts)); localStorage.setItem('FIN_V6_LOGS', JSON.stringify(logs)); updateUI(); }
    
    function exportExcelFull() {
        const wb = XLSX.utils.book_new();
        accounts.forEach(acc => {
            const accLogs = logs.filter(l => l.acc === acc);
            if(accLogs.length === 0) return;
            const rows = [ ["‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: " + acc], ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"] ];
            accLogs.forEach(l => rows.push([l.date, l.type, l.desc, l.amt]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), acc.substring(0,30));
        });
        XLSX.writeFile(wb, `Finance_Backup.xlsx`);
    }

    updateUI();
</script>
</body>
</html>
