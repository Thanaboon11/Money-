<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Manager - Separate Accounts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #5856d6; --success: #34c759; --danger: #ff3b30; --bg: #f4f4f9; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        
        /* ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏¢‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ */
        .account-summary-scroll { 
            display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 25px;
        }
        .acc-card { 
            min-width: 220px; background: white; padding: 20px; border-radius: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid var(--primary);
        }
        .acc-card h4 { margin: 0; color: #666; font-size: 14px; }
        .acc-card h2 { margin: 10px 0 0 0; color: var(--primary); font-size: 22px; }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô */
        .month-stats { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; 
        }
        .stat-box { padding: 20px; border-radius: 15px; color: white; text-align: center; }

        /* Main Content */
        .main-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .form-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        input, select, button { padding: 12px; border-radius: 10px; border: 1px solid #ddd; outline: none; }
        .btn-add { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; flex: 1; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: #888; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .income-val { color: var(--success); font-weight: bold; }
        .expense-val { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 style="text-align: center;">üè¶</h2>
<h2 style="text-align: center;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>

        <div>
            <input type="month" id="filterMonth" onchange="updateUI()">
            <button onclick="exportExcel()" style="background:#1d6f42; color:white; border:none; padding:10px; border-radius:10px; cursor:pointer;">Excel</button>
        </div>
    </div>

    <div id="accountCards" class="account-summary-scroll">
        </div>

    <div class="month-stats">
        <div class="stat-box" style="background: var(--success);">
            <small>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</small>
            <h2 id="totalMonthInc">0.00</h2>
        </div>
        <div class="stat-box" style="background: var(--danger);">
            <small>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</small>
            <h2 id="totalMonthExp">0.00</h2>
        </div>
    </div>

    <div class="main-grid">
        <div class="left-panel">
            <div class="card">
                <h3>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h3>
                <div class="form-group">
                    <input type="date" id="date" style="flex:1">
                    <select id="accSelect" style="flex:1"></select>
                    <select id="type" style="flex:1">
                        <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
                        <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" id="desc" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" style="flex:2">
                    <input type="number" id="amt" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" style="flex:1">
                    <button class="btn-add" onclick="addLog()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>

            <div class="card">
                <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="logTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="card">
                <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
                <canvas id="chartMonth"></canvas>
            </div>
            <div class="card">
                <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
                <div class="form-group">
                    <input type="text" id="newAccName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£, ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" style="flex:1">
                    <button onclick="addAccount()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
                <div id="accListUI"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let accounts = JSON.parse(localStorage.getItem('v5_accs')) || ['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ 1'];
    let logs = JSON.parse(localStorage.getItem('v5_logs')) || [];
    let myChart;

    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);

    function addAccount() {
        let name = document.getElementById('newAccName').value.trim();
        if(name && !accounts.includes(name)) {
            accounts.push(name);
            document.getElementById('newAccName').value = '';
            update();
        }
    }

    function removeAcc(name) {
        if(confirm(`‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${name}?`)) {
            accounts = accounts.filter(a => a !== name);
            update();
        }
    }

    function addLog() {
        let amt = parseFloat(document.getElementById('amt').value) || 0;
        let desc = document.getElementById('desc').value || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
        let date = document.getElementById('date').value;
        let acc = document.getElementById('accSelect').value;
        let type = document.getElementById('type').value;

        logs.push({ id: Date.now(), date, acc, type, desc, amt });
        document.getElementById('amt').value = '';
        update();
    }

    function deleteLog(id) {
        logs = logs.filter(l => l.id !== id);
        update();
    }

    function update() {
        localStorage.setItem('v5_accs', JSON.stringify(accounts));
        localStorage.setItem('v5_logs', JSON.stringify(logs));
        updateUI();
    }

    function updateUI() {
        const selMonth = document.getElementById('filterMonth').value;
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏¢‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏ö‡∏ö Running Total
        logs.sort((a,b) => new Date(a.date) - new Date(b.date));
        let runningBals = {};
        accounts.forEach(a => runningBals[a] = 0);
        
        let processedLogs = logs.map(l => {
            if (runningBals[l.acc] === undefined) runningBals[l.acc] = 0;
            if (l.type === 'income') runningBals[l.acc] += l.amt;
            else runningBals[l.acc] -= l.amt;
            return { ...l, balAfter: runningBals[l.acc] };
        });

        // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏¢‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°)
        const accCards = document.getElementById('accountCards');
        accCards.innerHTML = '';
        accounts.forEach(a => {
            accCards.innerHTML += `
                <div class="acc-card">
                    <h4>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${a}</h4>
                    <h2>${(runningBals[a] || 0).toLocaleString()} ‡∏ø</h2>
                </div>`;
        });

        // 2. ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏à‡πà‡∏≤‡∏¢ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        let mInc = 0, mExp = 0;
        processedLogs.forEach(l => {
            if(l.date.startsWith(selMonth)) {
                if(l.type === 'income') mInc += l.amt; else mExp += l.amt;
            }
        });
        document.getElementById('totalMonthInc').innerText = mInc.toLocaleString();
        document.getElementById('totalMonthExp').innerText = mExp.toLocaleString();

        // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Dropdown & List
        const sel = document.getElementById('accSelect');
        const list = document.getElementById('accListUI');
        sel.innerHTML = ''; list.innerHTML = '';
        accounts.forEach(a => {
            sel.innerHTML += `<option value="${a}">${a}</option>`;
            list.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>${a}</span> <button onclick="removeAcc('${a}')" style="padding:2px 5px; background:none; color:red; border:none; cursor:pointer;">‡∏•‡∏ö</button>
            </div>`;
        });

        // 4. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        const table = document.getElementById('logTable');
        table.innerHTML = '';
        [...processedLogs].reverse().filter(l => l.date.startsWith(selMonth)).forEach(l => {
            table.innerHTML += `<tr>
                <td>${l.date}</td>
                <td><small>${l.acc}</small></td>
                <td>${l.desc}</td>
                <td class="${l.type === 'income' ? 'income-val' : 'expense-val'}">
                    ${l.type === 'income' ? '+' : '-'}${l.amt.toLocaleString()}
                </td>
                <td style="font-weight:bold">${l.balAfter.toLocaleString()}</td>
                <td><button onclick="deleteLog(${l.id})" style="border:none; background:none; cursor:pointer;">‚úï</button></td>
            </tr>`;
        });

        renderChart(mInc, mExp);
    }

    function renderChart(inc, exp) {
        const ctx = document.getElementById('chartMonth').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'],
                datasets: [{
                    data: [inc, exp],
                    backgroundColor: ['#34c759', '#ff3b30'],
                    borderWidth: 0
                }]
            }
        });
    }

    function exportExcel() {
        const wb = XLSX.utils.book_new();
        accounts.forEach(acc => {
            const data = logs.filter(l => l.acc === acc).map(l => ({
                "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà": l.date, "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": l.desc, "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": l.type, "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": l.amt
            }));
            if(data.length > 0) {
                const ws = XLSX.utils.json_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, acc);
            }
        });
        XLSX.writeFile(wb, "Financial_Report.xlsx");
    }

    updateUI();
</script>

</body>
</html>